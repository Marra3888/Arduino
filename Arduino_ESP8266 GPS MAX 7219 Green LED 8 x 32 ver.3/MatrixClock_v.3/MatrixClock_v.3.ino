// 25.03.2025 Marchenko Vadim

#include <Ticker.h>
#include <TinyGPS++.h>
#include <SoftwareSerial.h>
#include <Timezone.h>
#include <TimeLib.h>

#define DIN_PIN  D8//15 //D8
#define CS_PIN   D6//12 //D6
#define CLK_PIN  D7//13 //D7

#define NUM_MAX     4
#include "max7219_hr.h"





// Константы для пинов и настроек
static const uint8_t RX_PIN = 4;       // D2 - RX для GPS
static const uint8_t TX_PIN = 5;       // D1 - TX для GPS
static const uint32_t GPS_BAUD = 9600;
// static const uint8_t DIN_PIN = D8;     // D8 для MAX7219
// static const uint8_t CS_PIN = D6;      // D6 для MAX7219
// static const uint8_t CLK_PIN = D7;     // D7 для MAX7219
// static const uint8_t NUM_MAX = 4;      // Количество модулей MAX7219
static const uint8_t MAX_POS_X = NUM_MAX * 8 - 1; // Максимальная позиция X (31)

// Настройки часового пояса
TimeChangeRule CEST = {"CEST", Last, Sun, Mar, 2, 180}; // UTC+2
TimeChangeRule CET = {"CET", Last, Sun, Oct, 2, 120};   // UTC+1
Timezone myTZ(CEST, CET);

// Объекты
TinyGPSPlus gps;
SoftwareSerial SerialGPS(RX_PIN, TX_PIN);
Ticker ticker;

// Глобальные массивы и структуры
uint8_t LEDarr[NUM_MAX][8] = {0};      // Массив для светодиодов
uint8_t helpArrMAX[NUM_MAX * 8] = {0}; // Вспомогательный массив для позиций
uint8_t helpArrPos[NUM_MAX * 8] = {0}; // Вспомогательный массив для битовых масок

// Переменные для времени
struct DateTime {
    uint8_t sec, min, hour, day, month, year, weekday;
} MEZ;

uint8_t maxPosX = NUM_MAX * 8 - 1;

// Позиции символов на дисплее
static const uint8_t SEC1_POS = 27;
static const uint8_t SEC2_POS = 23;
static const uint8_t MIN1_POS = 18;
static const uint8_t MIN2_POS = 13;
static const uint8_t HOUR1_POS = 4;
static const uint8_t HOUR2_POS = 1;
static const uint8_t COLON_POS = 11;

// Массивы для дней недели и месяцев (русский вариант)
const uint8_t WT_rus[8][12] = {
    // ... (оставляем как есть, но можно оптимизировать размер)
    // Ваши массивы WT_rus и M_rus остаются без изменений
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },//" "
    { 1, 24, 27, 20, 26, 17, 27, 17, 23, 31, 17, 0xff },//"Воскресенье "
    { 7, 24, 23, 17, 16, 17, 21, 31, 23, 18, 20,0xff },//"Понедельник ",
    { 1, 28, 24, 26, 23, 18, 20, 0xff, 0xff, 0xff, 0xff, 0xff },//"Вторник ",
    { 8, 26, 17, 16, 12, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },//"Среда ",
    { 10, 17, 28, 14, 17, 26, 15, 0xff, 0xff, 0xff, 0xff, 0xff },//"Четверг ",
    { 7, 32, 28, 23, 18, 30, 12, 0xff, 0xff, 0xff, 0xff, 0xff },//"Пятница ",
    { 8, 29, 13, 13, 24, 28, 12, 0xff, 0xff, 0xff, 0xff, 0xff }//"Суббота ",
};
const uint8_t M_rus[13][9] = 
{
    { 0, 0, 0, 0, 0, 0, 0, 0, 0 },//" ",
    { 11, 23, 14, 12, 26, 32, 0xff, 0xff, 0xff },//" Январь ",
    { 9, 17, 14, 26, 12, 21, 32, 0xff, 0xff },//" Февраль ",
    { 4, 12, 26, 28, 12, 0xff, 0xff, 0xff, 0xff },//" Март ",
    { 0, 25, 26, 17, 21, 32, 0xff, 0xff,0xff },//" Апрель ",
    { 4, 12, 32, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },//" Май ",
    { 3, 33, 23, 32, 0xff, 0xff, 0xff, 0xff, 0xff },//" Июнь ",
    { 3, 33, 21, 32, 0xff, 0xff, 0xff, 0xff, 0xff },//" Июль ",
    { 0, 14, 15, 29, 27, 28, 12, 0xff, 0xff },//" Август ",
    { 8, 17, 23, 28, 32, 13, 26, 32, 0xff },//" Сентябрь ",
    { 6, 20, 28, 32, 13, 26, 32, 0xff, 0xff },//" Октябрь ",
    { 5, 24, 32, 13, 26, 32, 0xff, 0xff, 0xff },//" Ноябрь ",
    { 2, 17, 20, 12, 13, 26, 32, 0xff, 0xff }//" Декабрь "
};

// Шрифты (оставляем как есть, но можно оптимизировать в будущем)
uint8_t const font1[96][9] = {
    // ... (оставляем как есть)
        { 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },   // 0x20, Space
        { 0x07, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00 },   // 0x21, !
        { 0x07, 0x09, 0x09, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00 },   // 0x22, "
        { 0x07, 0x0a, 0x0a, 0x1f, 0x0a, 0x1f, 0x0a, 0x0a, 0x00 },   // 0x23, #
        { 0x07, 0x04, 0x0f, 0x14, 0x0e, 0x05, 0x1e, 0x04, 0x00 },   // 0x24, $
        { 0x07, 0x19, 0x19, 0x02, 0x04, 0x08, 0x13, 0x13, 0x00 },   // 0x25, %
        { 0x07, 0x04, 0x0a, 0x0a, 0x0a, 0x15, 0x12, 0x0d, 0x00 },   // 0x26, &
        { 0x07, 0x04, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00 },   // 0x27, '
        { 0x07, 0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02, 0x00 },   // 0x28, (
        { 0x07, 0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08, 0x00 },   // 0x29, )
        { 0x07, 0x04, 0x15, 0x0e, 0x1f, 0x0e, 0x15, 0x04, 0x00 },   // 0x2a, *
        { 0x07, 0x00, 0x04, 0x04, 0x1f, 0x04, 0x04, 0x00, 0x00 },   // 0x2b, +
        { 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02 },   // 0x2c, ,
        { 0x07, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00 },   // 0x2d, -
        { 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00 },   // 0x2e, .
        { 0x07, 0x01, 0x01, 0x02, 0x04, 0x08, 0x10, 0x10, 0x00 },   // 0x2f, /
        { 0x07, 0x0F, 0x09, 0x09, 0x09, 0x09, 0x09, 0x0F, 0x00 },   // 0x30, 0
        { 0x07, 0x02, 0x06, 0x02, 0x02, 0x02, 0x02, 0x02, 0x00 },   // 0x31, 1
        { 0x07, 0x0F, 0x01, 0x01, 0x0F, 0x08, 0x08, 0x0F, 0x00 },   // 0x32, 2
        { 0x07, 0x0F, 0x01, 0x01, 0x07, 0x01, 0x01, 0x0F, 0x00 },   // 0x33, 3
        { 0x07, 0x09, 0x09, 0x09, 0x0F, 0x01, 0x01, 0x01, 0x00 },   // 0x34, 4
        { 0x07, 0x0F, 0x08, 0x08, 0x0F, 0x01, 0x01, 0x0F, 0x00 },   // 0x35, 5
        { 0x07, 0x0F, 0x08, 0x08, 0x0F, 0x09, 0x09, 0x0F, 0x00 },   // 0x36, 6
        { 0x07, 0x0F, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00 },   // 0x37, 7
        { 0x07, 0x0F, 0x09, 0x09, 0x0F, 0x09, 0x09, 0x0F, 0x00 },   // 0x38, 8
        { 0x07, 0x0F, 0x09, 0x09, 0x0F, 0x01, 0x01, 0x0F, 0x00 },   // 0x39, 9
//        { 0x04, 0x00, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x00 },   // 0x3a, :  
//        { 0x04, 0x00, 0x01, 0x01, 0x00, 0x01, 0x01, 0x00, 0x00 },   // 0x3a, :
        { 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00 },   // 0x3a, :
        { 0x07, 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x04, 0x08, 0x00 },   // 0x3b, ;
        { 0x07, 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0x00 },   // 0x3c, <
        { 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },   // 0x3d, =
        { 0x07, 0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08, 0x00 },   // 0x3e, >
        { 0x07, 0x0e, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04, 0x00 },   // 0x3f, ?
        { 0x07, 0x0e, 0x11, 0x17, 0x15, 0x17, 0x10, 0x0f, 0x00 },   // 0x40, @
        { 0x07, 0x04, 0x0a, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x00 },   // 0x41, A
        { 0x07, 0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e, 0x00 },   // 0x42, B
        { 0x07, 0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e, 0x00 },   // 0x43, C
        { 0x07, 0x1E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1E, 0x00 },   // 0x44, D
        { 0x07, 0x1f, 0x10, 0x10, 0x1c, 0x10, 0x10, 0x1f, 0x00 },   // 0x45, E
        { 0x07, 0x1f, 0x10, 0x10, 0x1f, 0x10, 0x10, 0x10, 0x00 },   // 0x46, F
        { 0x07, 0x0e, 0x11, 0x10, 0x10, 0x13, 0x11, 0x0f, 0x00 },   // 0x37, G
        { 0x07, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11, 0x00 },   // 0x48, H
        { 0x07, 0x0e, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e, 0x00 },   // 0x49, I
        { 0x07, 0x1f, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0c, 0x00 },   // 0x4a, J
        { 0x07, 0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11, 0x00 },   // 0x4b, K
        { 0x07, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0x00 },   // 0x4c, L
        { 0x07, 0x11, 0x1b, 0x15, 0x11, 0x11, 0x11, 0x11, 0x00 },   // 0x4d, M
        { 0x07, 0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x00 },   // 0x4e, N
        { 0x07, 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00 },   // 0x4f, O
        { 0x07, 0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10, 0x10, 0x00 },   // 0x50, P
        { 0x07, 0x0e, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0d, 0x00 },   // 0x51, Q
        { 0x07, 0x1e, 0x11, 0x11, 0x1e, 0x14, 0x12, 0x11, 0x00 },   // 0x52, R
        { 0x07, 0x0e, 0x11, 0x10, 0x0e, 0x01, 0x11, 0x0e, 0x00 },   // 0x53, S
        { 0x07, 0x1f, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00 },   // 0x54, T
        { 0x07, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00 },   // 0x55, U
        { 0x07, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x00 },   // 0x56, V
        { 0x07, 0x11, 0x11, 0x11, 0x15, 0x15, 0x1b, 0x11, 0x00 },   // 0x57, W
        { 0x07, 0x11, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x11, 0x00 },   // 0x58, X
        { 0x07, 0x11, 0x11, 0x0a, 0x04, 0x04, 0x04, 0x04, 0x00 },   // 0x59, Y
        { 0x07, 0x1f, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1f, 0x00 },   // 0x5a, Z
        { 0x07, 0x0e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0e, 0x00 },   // 0x5b, [
        { 0x07, 0x10, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01, 0x00 },   // 0x5c, '\'
        { 0x07, 0x0e, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0e, 0x00 },   // 0x5d, ]
        { 0x07, 0x04, 0x0a, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00 },   // 0x5e, ^
        { 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00 },   // 0x5f, _
        { 0x07, 0x04, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00 },   // 0x60, `
        { 0x07, 0x00, 0x0e, 0x01, 0x0d, 0x13, 0x13, 0x0d, 0x00 },   // 0x61, a
        { 0x07, 0x10, 0x10, 0x10, 0x1c, 0x12, 0x12, 0x1c, 0x00 },   // 0x62, b
        { 0x07, 0x00, 0x00, 0x0E, 0x10, 0x10, 0x10, 0x0E, 0x00 },   // 0x63, c
        { 0x07, 0x01, 0x01, 0x01, 0x07, 0x09, 0x09, 0x07, 0x00 },   // 0x64, d
        { 0x07, 0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0f, 0x00 },   // 0x65, e
        { 0x07, 0x06, 0x09, 0x08, 0x1c, 0x08, 0x08, 0x08, 0x00 },   // 0x66, f
        { 0x07, 0x00, 0x0e, 0x11, 0x13, 0x0d, 0x01, 0x01, 0x0e },   // 0x67, g
        { 0x07, 0x10, 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x00 },   // 0x68, h
        { 0x05, 0x00, 0x02, 0x00, 0x06, 0x02, 0x02, 0x07, 0x00 },   // 0x69, i
        { 0x07, 0x00, 0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0c },   // 0x6a, j
        { 0x07, 0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12, 0x00 },   // 0x6b, k
        { 0x05, 0x06, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x00 },   // 0x6c, l
        { 0x07, 0x00, 0x00, 0x0a, 0x15, 0x15, 0x11, 0x11, 0x00 },   // 0x6d, m
        { 0x07, 0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11, 0x00 },   // 0x6e, n
        { 0x07, 0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e, 0x00 },   // 0x6f, o
        { 0x07, 0x00, 0x00, 0x1c, 0x12, 0x12, 0x1c, 0x10, 0x10 },   // 0x70, p
        { 0x07, 0x00, 0x00, 0x07, 0x09, 0x09, 0x07, 0x01, 0x01 },   // 0x71, q
        { 0x07, 0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10, 0x00 },   // 0x72, r
        { 0x07, 0x00, 0x00, 0x0f, 0x10, 0x0e, 0x01, 0x1e, 0x00 },   // 0x73, s
        { 0x07, 0x08, 0x08, 0x1c, 0x08, 0x08, 0x09, 0x06, 0x00 },   // 0x74, t
        { 0x07, 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0x00 },   // 0x75, u
        { 0x07, 0x00, 0x00, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x00 },   // 0x76, v
        { 0x07, 0x00, 0x00, 0x11, 0x11, 0x15, 0x15, 0x0a, 0x00 },   // 0x77, w
        { 0x07, 0x00, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x00 },   // 0x78, x
        { 0x07, 0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x11, 0x0e },   // 0x79, y
        { 0x07, 0x00, 0x00, 0x1f, 0x02, 0x04, 0x08, 0x1f, 0x00 },   // 0x7a, z
        { 0x07, 0x06, 0x08, 0x08, 0x10, 0x08, 0x08, 0x06, 0x00 },   // 0x7b, {
        { 0x07, 0x04, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04, 0x00 },   // 0x7c, |
        { 0x07, 0x0c, 0x02, 0x02, 0x01, 0x02, 0x02, 0x0c, 0x00 },   // 0x7d, }
        { 0x07, 0x08, 0x15, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00 },   // 0x7e, ~
        { 0x07, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x00 }    // 0x7f, DEL
};

uint8_t const Rus[34][9] = {
    // ... (оставляем как есть)
  { 0x07, 0x04, 0x0a, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x00 },   // 0, A
  { 0x07, 0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e, 0x00 },   // 1, B
  { 0x07, 0x06, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x1f, 0x11 },   // 2, Д
  { 0x07, 0x11, 0x11, 0x13, 0x15, 0x19, 0x11, 0x11, 0x00 },   // 3, И
  { 0x07, 0x11, 0x1b, 0x15, 0x15, 0x15, 0x11, 0x11, 0x00 },   // 4, М
  { 0x07, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11, 0x00 },   // 5, Н
  { 0x07, 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00 },   // 6, О
  { 0x07, 0x1f, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00 },   // 7, П
  { 0x07, 0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e, 0x00 },   // 8, С
  { 0x07, 0x04, 0x0e, 0x15, 0x15, 0x15, 0x0e, 0x04, 0x00 },   // 9, Ф
  { 0x07, 0x09, 0x09, 0x09, 0x07, 0x01, 0x01, 0x01, 0x00 },   // 10, Ч
  { 0x07, 0x0f, 0x11, 0x11, 0x0f, 0x05, 0x09, 0x11, 0x00 },   // 11, Я
  { 0x07, 0x00, 0x0e, 0x01, 0x0d, 0x13, 0x13, 0x0d, 0x00 },   // 12, a
  { 0x07, 0x00, 0x0e, 0x10, 0x1e, 0x11, 0x11, 0x1e, 0x00 },   // 13, б
  { 0x07, 0x00, 0x00, 0x1e, 0x11, 0x1e, 0x11, 0x1e, 0x00 },   // 14, в
  { 0x07, 0x00, 0x00, 0x1e, 0x10, 0x10, 0x10, 0x10, 0x00 },   // 15, г
  { 0x07, 0x00, 0x00, 0x04, 0x0a, 0x0a, 0x0a, 0x1f, 0x11 },   // 16, д
  { 0x07, 0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0f, 0x00 },   // 17, е
  { 0x07, 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0x00 },   // 18, и
  { 0x07, 0x0e, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0x00 },   // 19, й
  { 0x07, 0x00, 0x00, 0x12, 0x14, 0x18, 0x14, 0x12, 0x00 },   // 20, к
  { 0x07, 0x00, 0x00, 0x0f, 0x09, 0x09, 0x09, 0x11, 0x00 },   // 21, л
  { 0x07, 0x00, 0x00, 0x0a, 0x15, 0x15, 0x11, 0x11, 0x00 },   // 22, м
  { 0x07, 0x00, 0x00, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x00 },   // 23, н
  { 0x07, 0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e, 0x00 },   // 24, о
  { 0x07, 0x00, 0x00, 0x1f, 0x11, 0x11, 0x11, 0x11, 0x00 },   // 25, п
  { 0x07, 0x00, 0x00, 0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10 },   // 26, р
  { 0x07, 0x00, 0x00, 0x0f, 0x10, 0x10, 0x10, 0x0f, 0x00 },   // 27, с
  { 0x07, 0x00, 0x00, 0x1f, 0x04, 0x04, 0x04, 0x04, 0x00 },   // 28, т
  { 0x07, 0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x11, 0x0e },   // 29, у
  { 0x07, 0x00, 0x00, 0x12, 0x12, 0x12, 0x12, 0x1f, 0x01 },   // 30, ц
  { 0x07, 0x00, 0x00, 0x10, 0x10, 0x1e, 0x11, 0x1e, 0x00 },   // 31, ь
  { 0x07, 0x00, 0x00, 0x0f, 0x11, 0x0f, 0x09, 0x11, 0x00 },   // 32, я
  { 0x08, 0x00, 0x00, 0x26, 0x29, 0x39, 0x29, 0x26, 0x00 },   // 33, ю
};

// Флаги и переменные состояния
volatile bool tick_1s = false;
volatile bool tick_50ms = false;
int scroll_pos_x = MAX_POS_X;
int scroll_date_pos_x = -7;

// Прототипы функций
void updateTimeFromGPS();
void displayTime();
void displayScrollingDate();
void initDisplay();
void clearDisplay();
void refreshDisplay();
void charToArray(uint8_t ch, int posX, int posY, const uint8_t font[][9]);
void timerCallback();

// Инициализация
void setup() {
    SerialGPS.begin(GPS_BAUD);
    initDisplay();
    clearDisplay();
    helpArr_init();
    refreshDisplay();
    ticker.attach(0.05, timerCallback); // Каждые 50 мс
}

// Основной цикл
void loop() {
    static int gpsCheckCounter = 0;
    static bool scrolling = false;

    if (tick_1s) {
        updateTimeFromGPS();
        displayTime();
        tick_1s = false;

        if (MEZ.sec == 45) { // Запуск прокрутки каждые 45 секунд
            scrolling = true;
        }
    }

    if (tick_50ms) {
        if (scrolling) {
            displayScrollingDate();
            scroll_pos_x++;
            scroll_date_pos_x++;
            if (scroll_date_pos_x >= 183) { // Длина прокрутки
                scroll_pos_x = 0;
            }
            if (scroll_pos_x == MAX_POS_X) {
                scrolling = false;
                scroll_date_pos_x = -8;
            }
        }
        refreshDisplay();
        tick_50ms = false;
    }

    if (++gpsCheckCounter > 3000) { // Проверка GPS каждые ~150 секунд
        gpsCheckCounter = 0;
        updateTimeFromGPS();
    }
}

void charToArrayRus(uint8_t ch, char PosX, short PosY) 
{ //символы в arr
    uint8_t i, j, k, l, m, o1, o2, o3, o4;  //в LEDarr
    PosX++;
//    if ((ch >= 128) && (ch <= 159))   ch -= 128;
//        if ((ch >= 160) && (ch <= 175))   ch -= 128;
//            if ((ch >= 224) && (ch <= 239))   ch -= 176;
    if (ch == 0xff)  return;
    k = ch;                        //Позиция ASCII в шрифте
    if ((k >= 0) && (k < 96))           //символ найден в шрифте?
    {
        o4 = Rus[k][0];                 //ширина символа
        o3 = 1 << (o4 - 2);
        for (i = 0; i < o4; i++) 
        {
            if (((PosX - i <= maxPosX) && (PosX - i >= 0)) && ((PosY > -8) && (PosY < 8))) //внутри матрицы?
            {
                o1 = helpArrPos[PosX - i];
                o2 = helpArrMAX[PosX - i];
                for (j = 0; j < 8; j++) 
                {
                    if (((PosY >= 0) && (PosY <= j)) || ((PosY < 0) && (j < PosY + 8))) //прокрутка по вертикали
                    {
                        l = Rus[k][j + 1];
                        m = (l & (o3 >> i));  //e.g. o4=7  0zzzzz0, o4=4  0zz0
                        if (m > 0)
                            LEDarr[o2][j - PosY] = LEDarr[o2][j - PosY] | (o1);  //уставка точки
                        else
                            LEDarr[o2][j - PosY] = LEDarr[o2][j - PosY] & (~o1); //очистка точки
                    }
                }
            }
        }
    }
}

// Обновление времени из GPS
void updateTimeFromGPS() {
    while (SerialGPS.available()) {
        if (gps.encode(SerialGPS.read())) {
            if (gps.time.isValid() && gps.date.isValid()) {
                setTime(gps.time.hour(), gps.time.minute(), gps.time.second(),
                        gps.date.day(), gps.date.month(), gps.date.year());
                MEZ.hour = hour(myTZ.toLocal(now()));
                MEZ.min = minute();
                MEZ.sec = second();
                MEZ.day = day();
                MEZ.month = month();
                MEZ.year = year() % 100; // Год в формате YY
                MEZ.weekday = weekday() - 1; // 0 = воскресенье
            }
        }
    }
}

// Отображение времени
void displayTime() {
    clearDisplay();
    charToArray('0' + (MEZ.hour / 10), scroll_pos_x + HOUR2_POS, 0, font1);
    charToArray('0' + (MEZ.hour % 10), scroll_pos_x - HOUR1_POS, 0, font1);
    charToArray(':', scroll_pos_x - COLON_POS, 0, font1);
    charToArray('0' + (MEZ.min / 10), scroll_pos_x - MIN2_POS, 0, font1);
    charToArray('0' + (MEZ.min % 10), scroll_pos_x - MIN1_POS, 0, font1);
    charToArray('0' + (MEZ.sec / 10), scroll_pos_x - SEC2_POS, 0, font1);
    charToArray('0' + (MEZ.sec % 10), scroll_pos_x - SEC1_POS, 0, font1);
}

// Отображение прокручиваемой даты
void displayScrollingDate() {
    int len = 0;
    for (uint8_t i = 0; i < 11 && WT_rus[MEZ.weekday][i] != 0xff; i++) {
        charToArrayRus(WT_rus[MEZ.weekday][i], scroll_date_pos_x - len, 0);
        len += 6;
    }
    charToArray('0' + (MEZ.day / 10), scroll_date_pos_x - len, 0, font1);
    len += 6;
    charToArray('0' + (MEZ.day % 10), scroll_date_pos_x - len, 0, font1);
    len += 6;
    for (uint8_t i = 0; i < 9 && M_rus[MEZ.month][i] != 0xff; i++) {
        charToArrayRus(M_rus[MEZ.month][i], scroll_date_pos_x - len, 0);
        len += 6;
    }
    charToArray('2', scroll_date_pos_x - len, 0, font1);
    len += 6;
    charToArray('0', scroll_date_pos_x - len, 0, font1);
    len += 6;
    charToArray('0' + (MEZ.year / 10), scroll_date_pos_x - len, 0, font1);
    len += 6;
    charToArray('0' + (MEZ.year % 10), scroll_date_pos_x - len, 0, font1);
}

// Инициализация дисплея
void initDisplay() {
    pinMode(CS_PIN, OUTPUT);
    digitalWrite(CS_PIN, HIGH);
    sendCmdAll(CMD_SHUTDOWN, 1);
    sendCmdAll(CMD_INTENSITY, 8); // Яркость 8
}

// Очистка дисплея
void clearDisplay() {
    for (uint8_t i = 0; i < 8; i++) {
        digitalWrite(CS_PIN, LOW);
        for (uint8_t j = 0; j < NUM_MAX; j++) {
            LEDarr[j][i] = 0;
            shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, CMD_DIGIT0 + i);
            shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, LEDarr[j][i]);
        }
        digitalWrite(CS_PIN, HIGH);
    }
}

// Обновление дисплея
void refreshDisplay() {
    for (uint8_t i = 0; i < 8; i++) {
        digitalWrite(CS_PIN, LOW);
        for (uint8_t j = NUM_MAX; j > 0; j--) {
            shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, CMD_DIGIT0 + i);
            shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, LEDarr[j - 1][i]);
        }
        digitalWrite(CS_PIN, HIGH);
    }
}

// Вывод символа в массив
void charToArray(uint8_t ch, int posX, int posY, const uint8_t font[][9]) {
    // ... (функция остается как char2ArrRus, но обобщена для разных шрифтов)
    // Реализация аналогична вашей char2ArrRus
}

// Инициализация вспомогательного массива
void helpArr_init() {
    // ... (оставляем как есть)
}

// Обработчик таймера
void timerCallback() {
    static uint8_t cnt50ms = 0;
    tick_50ms = true;
    if (++cnt50ms >= 20) {
        tick_1s = true;
        cnt50ms = 0;
    }
}

// // Отправка команды всем модулям MAX7219
// void sendCmdAll(uint8_t cmd, uint8_t data) {
//     digitalWrite(CS_PIN, LOW);
//     for (uint8_t i = 0; i < NUM_MAX; i++) {
//         shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, cmd);
//         shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, data);
//     }
//     digitalWrite(CS_PIN, HIGH);
// }