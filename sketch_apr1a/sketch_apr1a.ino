#include <Ticker.h>
// #include <MD_DS3231.h>
#include <Timezone.h>
#include <Time.h>
#include <Wire.h>
#include <RTClib.h> 

TimeChangeRule myDST = {"CEST", Last, Sun, Mar, 2, 180}; // Central European Summer Time
TimeChangeRule mySTD = {"CET", Last, Sun, Oct, 2, 120};  // Central European Time
Timezone myTZ(myDST, mySTD);

#define DIN_PIN D8 // Data In pin for MAX7219
#define CS_PIN  D6 // Chip Select pin for MAX7219
#define CLK_PIN D7 // Clock pin for MAX7219

// #define SDA_PIN D2
// #define SCL_PIN D1

#define NUM_MAX 4  // Number of MAX7219 modules
#include "max7219_hr.h" // Assumed custom header for MAX7219 control

uint8_t maxPosX = NUM_MAX * 8 - 1;            
uint8_t LEDarr[NUM_MAX][8];                   
uint8_t helpArrMAX[NUM_MAX * 8];              
uint8_t helpArrPos[NUM_MAX * 8];
uint8_t z_PosX = 0;                            
uint8_t d_PosX = 0;                            
bool f_tckr1s = false;
bool f_tckr50ms = false;

#define REVERSE_VERTICAL // For IC-Station display orientation
#define Russian          // Enable Russian text support

struct MyDateTime 
{
    uint8_t sek1, sek2, sek12, min1, min2, min12, hour1, hour2, hour12;
    uint8_t tag1, tag2, tag12, mon1, mon2, mon12, year1, year2, year12, WT;
} MEZ;

byte Tag, Monat, WoTag, Stunde, Minute, Sekunde;
int Jahr;

Ticker tckr;
RTC_DS3231 rtc; // Объявление объекта RTC

byte sec1_position = 27;
byte sec2_position = 23;
byte min1_position = 18;
byte min2_position = 13;
byte hour1_position = 4;
byte hour2_position = 1;
byte colon_position = 11;

char M_arr[12][5] = 
{
    {' ', 'J', 'A', 'N', ' '}, {' ', 'F', 'E', 'B', ' '}, {' ', 'M', 'A', 'R', ' '},
    {' ', 'A', 'P', 'R', ' '}, {' ', 'M', 'A', 'Y', ' '}, {' ', 'J', 'U', 'N', ' '},
    {' ', 'J', 'U', 'L', ' '}, {' ', 'A', 'U', 'G', ' '}, {' ', 'S', 'E', 'P', ' '},
    {' ', 'O', 'C', 'T', ' '}, {' ', 'N', 'O', 'V', ' '}, {' ', 'D', 'E', 'C', ' '}
};

char WT_arr[7][4] = 
{
    {'S', 'U', 'N', ' '}, {'M', 'O', 'N', ' '}, {'T', 'U', 'E', ' '},
    {'W', 'E', 'D', ' '}, {'T', 'H', 'U', ' '}, {'F', 'R', 'I', ' '},
    {'S', 'A', 'T', ' '}
};

const uint8_t M_rus[13][9] = 
{
    {0, 0, 0, 0, 0, 0, 0, 0, 0},           // Empty
    {11, 23, 14, 12, 26, 32, 0xff, 0xff, 0xff}, // ЯНВАРЬ (January)
    {9, 17, 14, 26, 12, 21, 32, 0xff, 0xff},    // ФЕВРАЛЬ (February)
    {4, 12, 26, 28, 12, 0xff, 0xff, 0xff, 0xff}, // МАРТ (March)
    {0, 25, 26, 17, 21, 32, 0xff, 0xff, 0xff},  // АПРЕЛЬ (April)
    {4, 12, 32, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff}, // МАЙ (May)
    {3, 33, 23, 32, 0xff, 0xff, 0xff, 0xff, 0xff},   // ИЮНЬ (June)
    {3, 33, 21, 32, 0xff, 0xff, 0xff, 0xff, 0xff},   // ИЮЛЬ (July)
    {0, 14, 15, 29, 27, 28, 12, 0xff, 0xff},        // АВГУСТ (August)
    {8, 17, 23, 28, 32, 13, 26, 32, 0xff},          // СЕНТЯБРЬ (September)
    {6, 20, 28, 32, 13, 26, 32, 0xff, 0xff},        // ОКТЯБРЬ (October)
    {5, 24, 32, 13, 26, 32, 0xff, 0xff, 0xff},      // НОЯБРЬ (November)
    {2, 17, 20, 12, 13, 26, 32, 0xff, 0xff}         // ДЕКАБРЬ (December)
};

const uint8_t WT_rus[8][12] = 
{
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},           // Empty
    {1, 24, 27, 20, 26, 17, 27, 17, 23, 31, 17, 0xff}, // ВОСКРЕСЕНЬЕ (Sunday)
    {7, 24, 23, 17, 16, 17, 21, 31, 23, 18, 20, 0xff}, // ПОНЕДЕЛЬНИК (Monday)
    {1, 28, 24, 26, 23, 18, 20, 0xff, 0xff, 0xff, 0xff, 0xff}, // ВТОРНИК (Tuesday)
    {8, 26, 17, 16, 12, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff}, // СРЕДА (Wednesday)
    {10, 17, 28, 14, 17, 26, 15, 0xff, 0xff, 0xff, 0xff, 0xff}, // ЧЕТВЕРГ (Thursday)
    {7, 32, 28, 23, 18, 30, 12, 0xff, 0xff, 0xff, 0xff, 0xff}, // ПЯТНИЦА (Friday)
    {8, 29, 13, 13, 24, 28, 12, 0xff, 0xff, 0xff, 0xff, 0xff}  // СУББОТА (Saturday)
};

uint8_t const font1[96][9] = 
{
    {0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // Space
    {0x07, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00}, // !
    {0x07, 0x09, 0x09, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00}, // "
    {0x07, 0x0a, 0x0a, 0x1f, 0x0a, 0x1f, 0x0a, 0x0a, 0x00}, // #
    {0x07, 0x04, 0x0f, 0x14, 0x0e, 0x05, 0x1e, 0x04, 0x00}, // $
    {0x07, 0x19, 0x19, 0x02, 0x04, 0x08, 0x13, 0x13, 0x00}, // %
    {0x07, 0x04, 0x0a, 0x0a, 0x0a, 0x15, 0x12, 0x0d, 0x00}, // &
    {0x07, 0x04, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00}, // '
    {0x07, 0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02, 0x00}, // (
    {0x07, 0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08, 0x00}, // )
    {0x07, 0x04, 0x15, 0x0e, 0x1f, 0x0e, 0x15, 0x04, 0x00}, // *
    {0x07, 0x00, 0x04, 0x04, 0x1f, 0x04, 0x04, 0x00, 0x00}, // +
    {0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02}, // ,
    {0x07, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00}, // -
    {0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00}, // .
    {0x07, 0x01, 0x01, 0x02, 0x04, 0x08, 0x10, 0x10, 0x00}, // /
    {0x07, 0x0F, 0x09, 0x09, 0x09, 0x09, 0x09, 0x0F, 0x00}, // 0
    {0x07, 0x02, 0x06, 0x02, 0x02, 0x02, 0x02, 0x02, 0x00}, // 1
    {0x07, 0x0F, 0x01, 0x01, 0x0F, 0x08, 0x08, 0x0F, 0x00}, // 2
    {0x07, 0x0F, 0x01, 0x01, 0x07, 0x01, 0x01, 0x0F, 0x00}, // 3
    {0x07, 0x09, 0x09, 0x09, 0x0F, 0x01, 0x01, 0x01, 0x00}, // 4
    {0x07, 0x0F, 0x08, 0x08, 0x0F, 0x01, 0x01, 0x0F, 0x00}, // 5
    {0x07, 0x0F, 0x08, 0x08, 0x0F, 0x09, 0x09, 0x0F, 0x00}, // 6
    {0x07, 0x0F, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00}, // 7
    {0x07, 0x0F, 0x09, 0x09, 0x0F, 0x09, 0x09, 0x0F, 0x00}, // 8
    {0x07, 0x0F, 0x09, 0x09, 0x0F, 0x01, 0x01, 0x0F, 0x00}, // 9
    {0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00}, // :
    {0x07, 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x04, 0x08, 0x00}, // ;
    {0x07, 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0x00}, // <
    {0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // =
    {0x07, 0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08, 0x00}, // >
    {0x07, 0x0e, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04, 0x00}, // ?
    {0x07, 0x0e, 0x11, 0x17, 0x15, 0x17, 0x10, 0x0f, 0x00}, // @
    {0x07, 0x04, 0x0a, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x00}, // A
    {0x07, 0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e, 0x00}, // B
    {0x07, 0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e, 0x00}, // C
    {0x07, 0x1E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1E, 0x00}, // D
    {0x07, 0x1f, 0x10, 0x10, 0x1c, 0x10, 0x10, 0x1f, 0x00}, // E
    {0x07, 0x1f, 0x10, 0x10, 0x1f, 0x10, 0x10, 0x10, 0x00}, // F
    {0x07, 0x0e, 0x11, 0x10, 0x10, 0x13, 0x11, 0x0f, 0x00}, // G
    {0x07, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11, 0x00}, // H
    {0x07, 0x0e, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e, 0x00}, // I
    {0x07, 0x1f, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0c, 0x00}, // J
    {0x07, 0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11, 0x00}, // K
    {0x07, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0x00}, // L
    {0x07, 0x11, 0x1b, 0x15, 0x11, 0x11, 0x11, 0x11, 0x00}, // M
    {0x07, 0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x00}, // N
    {0x07, 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00}, // O
    {0x07, 0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10, 0x10, 0x00}, // P
    {0x07, 0x0e, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0d, 0x00}, // Q
    {0x07, 0x1e, 0x11, 0x11, 0x1e, 0x14, 0x12, 0x11, 0x00}, // R
    {0x07, 0x0e, 0x11, 0x10, 0x0e, 0x01, 0x11, 0x0e, 0x00}, // S
    {0x07, 0x1f, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00}, // T
    {0x07, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00}, // U
    {0x07, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x00}, // V
    {0x07, 0x11, 0x11, 0x15, 0x15, 0x1b, 0x11, 0x11, 0x00}, // W
    {0x07, 0x11, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x11, 0x00}, // X
    {0x07, 0x11, 0x11, 0x0a, 0x04, 0x04, 0x04, 0x04, 0x00}, // Y
    {0x07, 0x1f, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1f, 0x00}, // Z
    {0x07, 0x0e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0e, 0x00}, // [
    {0x07, 0x10, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01, 0x00}, // '\'
    {0x07, 0x0e, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0e, 0x00}, // ]
    {0x07, 0x04, 0x0a, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00}, // ^
    {0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00}, // _
    {0x07, 0x04, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00}, // `
    {0x07, 0x00, 0x0e, 0x01, 0x0d, 0x13, 0x13, 0x0d, 0x00}, // a
    {0x07, 0x10, 0x10, 0x10, 0x1c, 0x12, 0x12, 0x1c, 0x00}, // b
    {0x07, 0x00, 0x00, 0x0e, 0x10, 0x10, 0x10, 0x0e, 0x00}, // c
    {0x07, 0x01, 0x01, 0x01, 0x07, 0x09, 0x09, 0x07, 0x00}, // d
    {0x07, 0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0f, 0x00}, // e
    {0x07, 0x06, 0x09, 0x08, 0x1c, 0x08, 0x08, 0x08, 0x00}, // f
    {0x07, 0x00, 0x0e, 0x11, 0x13, 0x0d, 0x01, 0x01, 0x0e}, // g
    {0x07, 0x10, 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x00}, // h
    {0x05, 0x00, 0x02, 0x00, 0x06, 0x02, 0x02, 0x07, 0x00}, // i
    {0x07, 0x00, 0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0c}, // j
    {0x07, 0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12, 0x00}, // k
    {0x05, 0x06, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x00}, // l
    {0x07, 0x00, 0x00, 0x0a, 0x15, 0x15, 0x11, 0x11, 0x00}, // m
    {0x07, 0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11, 0x00}, // n
    {0x07, 0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e, 0x00}, // o
    {0x07, 0x00, 0x00, 0x1c, 0x12, 0x12, 0x1c, 0x10, 0x10}, // p
    {0x07, 0x00, 0x00, 0x07, 0x09, 0x09, 0x07, 0x01, 0x01}, // q
    {0x07, 0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10, 0x00}, // r
    {0x07, 0x00, 0x00, 0x0f, 0x10, 0x0e, 0x01, 0x1e, 0x00}, // s
    {0x07, 0x08, 0x08, 0x1c, 0x08, 0x08, 0x09, 0x06, 0x00}, // t
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0x00}, // u
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x00}, // v
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x15, 0x15, 0x0a, 0x00}, // w
    {0x07, 0x00, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x00}, // x
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x11, 0x0e}, // y
    {0x07, 0x00, 0x00, 0x1f, 0x02, 0x04, 0x08, 0x1f, 0x00}, // z
    {0x07, 0x06, 0x08, 0x08, 0x10, 0x08, 0x08, 0x06, 0x00}, // {
    {0x07, 0x04, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04, 0x00}, // |
    {0x07, 0x0c, 0x02, 0x02, 0x01, 0x02, 0x02, 0x0c, 0x00}, // }
    {0x07, 0x08, 0x15, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00}, // ~
    {0x07, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x00}  // DEL
};

uint8_t const font2[96][9] = 
{
    {0x07, 0x00, 0x00, 0x00, 0x00, 0x00A, 0x00, 0x00, 0x00}, // Space
    {0x07, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00}, // !
    {0x07, 0x09, 0x09, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00}, // "
    {0x07, 0x0a, 0x0a, 0x1f, 0x0a, 0x1f, 0x0a, 0x0a, 0x00}, // #
    {0x07, 0x04, 0x0f, 0x14, 0x0e, 0x05, 0x1e, 0x04, 0x00}, // $
    {0x07, 0x19, 0x19, 0x02, 0x04, 0x08, 0x13, 0x13, 0x00}, // %
    {0x07, 0x04, 0x0a, 0x0a, 0x0a, 0x15, 0x12, 0x0d, 0x00}, // &
    {0x07, 0x04, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00}, // '
    {0x07, 0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02, 0x00}, // (
    {0x07, 0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08, 0x00}, // )
    {0x07, 0x04, 0x15, 0x0e, 0x1f, 0x0e, 0x15, 0x04, 0x00}, // *
    {0x07, 0x00, 0x04, 0x04, 0x1f, 0x04, 0x04, 0x00, 0x00}, // +
    {0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02}, // ,
    {0x07, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00}, // -
    {0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00}, // .
    {0x07, 0x01, 0x01, 0x02, 0x04, 0x08, 0x10, 0x10, 0x00}, // /
    {0x07, 0x00, 0x00, 0x07, 0x05, 0x05, 0x05, 0x07, 0x00}, // 0
    {0x07, 0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x02, 0x00}, // 1
    {0x07, 0x00, 0x00, 0x07, 0x01, 0x07, 0x04, 0x07, 0x00}, // 2
    {0x07, 0x00, 0x00, 0x07, 0x01, 0x07, 0x01, 0x07, 0x00}, // 3
    {0x07, 0x00, 0x00, 0x05, 0x05, 0x07, 0x01, 0x01, 0x00}, // 4
    {0x07, 0x00, 0x00, 0x07, 0x04, 0x07, 0x01, 0x07, 0x00}, // 5
    {0x07, 0x00, 0x00, 0x07, 0x04, 0x07, 0x05, 0x07, 0x00}, // 6
    {0x07, 0x00, 0x00, 0x07, 0x01, 0x01, 0x01, 0x01, 0x00}, // 7
    {0x07, 0x00, 0x00, 0x07, 0x05, 0x07, 0x05, 0x07, 0x00}, // 8
    {0x07, 0x00, 0x00, 0x07, 0x05, 0x07, 0x01, 0x07, 0x00}, // 9
    {0x04, 0x00, 0x03, 0x03, 0x00, 0x03, 0x03, 0x00, 0x00}, // :
    {0x07, 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x04, 0x08, 0x00}, // ;
    {0x07, 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0x00}, // <
    {0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // =
    {0x07, 0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08, 0x00}, // >
    {0x07, 0x0e, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04, 0x00}, // ?
    {0x07, 0x0e, 0x11, 0x17, 0x15, 0x17, 0x10, 0x0f, 0x00}, // @
    {0x07, 0x04, 0x0a, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x00}, // A
    {0x07, 0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e, 0x00}, // B
    {0x07, 0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e, 0x00}, // C
    {0x07, 0x1E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1E, 0x00}, // D
    {0x07, 0x1f, 0x10, 0x10, 0x1c, 0x10, 0x10, 0x1f, 0x00}, // E
    {0x07, 0x1f, 0x10, 0x10, 0x1f, 0x10, 0x10, 0x10, 0x00}, // F
    {0x07, 0x0e, 0x11, 0x10, 0x10, 0x13, 0x11, 0x0f, 0x00}, // G
    {0x07, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11, 0x00}, // H
    {0x07, 0x0e, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e, 0x00}, // I
    {0x07, 0x1f, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0c, 0x00}, // J
    {0x07, 0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11, 0x00}, // K
    {0x07, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0x00}, // L
    {0x07, 0x11, 0x1b, 0x15, 0x11, 0x11, 0x11, 0x11, 0x00}, // M
    {0x07, 0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x00}, // N
    {0x07, 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00}, // O
    {0x07, 0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10, 0x10, 0x00}, // P
    {0x07, 0x0e, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0d, 0x00}, // Q
    {0x07, 0x1e, 0x11, 0x11, 0x1e, 0x14, 0x12, 0x11, 0x00}, // R
    {0x07, 0x0e, 0x11, 0x10, 0x0e, 0x01, 0x11, 0x0e, 0x00}, // S
    {0x07, 0x1f, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00}, // T
    {0x07, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00}, // U
    {0x07, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x00}, // V
    {0x07, 0x11, 0x11, 0x15, 0x15, 0x1b, 0x11, 0x11, 0x00}, // W
    {0x07, 0x11, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x11, 0x00}, // X
    {0x07, 0x11, 0x11, 0x0a, 0x04, 0x04, 0x04, 0x04, 0x00}, // Y
    {0x07, 0x1f, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1f, 0x00}, // Z
    {0x07, 0x0e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0e, 0x00}, // [
    {0x07, 0x10, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01, 0x00}, // '\'
    {0x07, 0x0e, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0e, 0x00}, // ]
    {0x07, 0x04, 0x0a, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00}, // ^
    {0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00}, // _
    {0x07, 0x04, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00}, // `
    {0x07, 0x00, 0x0e, 0x01, 0x0d, 0x13, 0x13, 0x0d, 0x00}, // a
    {0x07, 0x10, 0x10, 0x10, 0x1c, 0x12, 0x12, 0x1c, 0x00}, // b
    {0x07, 0x00, 0x00, 0x0e, 0x10, 0x10, 0x10, 0x0e, 0x00}, // c
    {0x07, 0x01, 0x01, 0x01, 0x07, 0x09, 0x09, 0x07, 0x00}, // d
    {0x07, 0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0f, 0x00}, // e
    {0x07, 0x06, 0x09, 0x08, 0x1c, 0x08, 0x08, 0x08, 0x00}, // f
    {0x07, 0x00, 0x0e, 0x11, 0x13, 0x0d, 0x01, 0x01, 0x0e}, // g
    {0x07, 0x10, 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x00}, // h
    {0x05, 0x00, 0x02, 0x00, 0x06, 0x02, 0x02, 0x07, 0x00}, // i
    {0x07, 0x00, 0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0c}, // j
    {0x07, 0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12, 0x00}, // k
    {0x05, 0x06, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x00}, // l
    {0x07, 0x00, 0x00, 0x0a, 0x15, 0x15, 0x11, 0x11, 0x00}, // m
    {0x07, 0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11, 0x00}, // n
    {0x07, 0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e, 0x00}, // o
    {0x07, 0x00, 0x00, 0x1c, 0x12, 0x12, 0x1c, 0x10, 0x10}, // p
    {0x07, 0x00, 0x00, 0x07, 0x09, 0x09, 0x07, 0x01, 0x01}, // q
    {0x07, 0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10, 0x00}, // r
    {0x07, 0x00, 0x00, 0x0f, 0x10, 0x0e, 0x01, 0x1e, 0x00}, // s
    {0x07, 0x08, 0x08, 0x1c, 0x08, 0x08, 0x09, 0x06, 0x00}, // t
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0x00}, // u
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x00}, // v
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x15, 0x15, 0x0a, 0x00}, // w
    {0x07, 0x00, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x00}, // x
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x11, 0x0e}, // y
    {0x07, 0x00, 0x00, 0x1f, 0x02, 0x04, 0x08, 0x1f, 0x00}, // z
    {0x07, 0x06, 0x08, 0x08, 0x10, 0x08, 0x08, 0x06, 0x00}, // {
    {0x07, 0x04, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04, 0x00}, // |
    {0x07, 0x0c, 0x02, 0x02, 0x01, 0x02, 0x02, 0x0c, 0x00}, // }
    {0x07, 0x08, 0x15, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00}, // ~
    {0x07, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x00}  // DEL
};

uint8_t const Rus[34][9] = 
{
    {0x07, 0x04, 0x0a, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x00}, // 0, А
    {0x07, 0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e, 0x00}, // 1, Б
    {0x07, 0x06, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x1f, 0x11}, // 2, Д
    {0x07, 0x11, 0x11, 0x13, 0x15, 0x19, 0x11, 0x11, 0x00}, // 3, И
    {0x07, 0x11, 0x1b, 0x15, 0x15, 0x15, 0x11, 0x11, 0x00}, // 4, М
    {0x07, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11, 0x00}, // 5, Н
    {0x07, 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00}, // 6, О
    {0x07, 0x1f, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00}, // 7, П
    {0x07, 0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e, 0x00}, // 8, С
    {0x07, 0x04, 0x0e, 0x15, 0x15, 0x15, 0x0e, 0x04, 0x00}, // 9, Ф
    {0x07, 0x09, 0x09, 0x09, 0x07, 0x01, 0x01, 0x01, 0x00}, // 10, Ч
    {0x07, 0x0f, 0x11, 0x11, 0x0f, 0x05, 0x09, 0x11, 0x00}, // 11, Я
    {0x07, 0x00, 0x0e, 0x01, 0x0d, 0x13, 0x13, 0x0d, 0x00}, // 12, а
    {0x07, 0x00, 0x0e, 0x10, 0x1e, 0x11, 0x11, 0x1e, 0x00}, // 13, б
    {0x07, 0x00, 0x00, 0x1e, 0x11, 0x1e, 0x11, 0x1e, 0x00}, // 14, в
    {0x07, 0x00, 0x00, 0x1e, 0x10, 0x10, 0x10, 0x10, 0x00}, // 15, г
    {0x07, 0x00, 0x00, 0x04, 0x0a, 0x0a, 0x0a, 0x1f, 0x11}, // 16, д
    {0x07, 0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0f, 0x00}, // 17, е
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0x00}, // 18, и
    {0x07, 0x0e, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0x00}, // 19, й
    {0x07, 0x00, 0x00, 0x12, 0x14, 0x18, 0x14, 0x12, 0x00}, // 20, к
    {0x07, 0x00, 0x00, 0x0f, 0x09, 0x09, 0x09, 0x11, 0x00}, // 21, л
    {0x07, 0x00, 0x00, 0x0a, 0x15, 0x15, 0x11, 0x11, 0x00}, // 22, м
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x00}, // 23, н
    {0x07, 0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e, 0x00}, // 24, о
    {0x07, 0x00, 0x00, 0x1f, 0x11, 0x11, 0x11, 0x11, 0x00}, // 25, п
    {0x07, 0x00, 0x00, 0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10}, // 26, р
    {0x07, 0x00, 0x00, 0x0f, 0x10, 0x10, 0x10, 0x0f, 0x00}, // 27, с
    {0x07, 0x00, 0x00, 0x1f, 0x04, 0x04, 0x04, 0x04, 0x00}, // 28, т
    {0x07, 0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x11, 0x0e}, // 29, у
    {0x07, 0x00, 0x00, 0x12, 0x12, 0x12, 0x12, 0x1f, 0x01}, // 30, ц
    {0x07, 0x00, 0x00, 0x10, 0x10, 0x1e, 0x11, 0x1e, 0x00}, // 31, ь
    {0x07, 0x00, 0x00, 0x0f, 0x11, 0x0f, 0x09, 0x11, 0x00}, // 32, я
    {0x08, 0x00, 0x00, 0x26, 0x29, 0x39, 0x29, 0x26, 0x00}  // 33, ю
};

// void rtc2mez()
// {
//     RTC.readTime(); // Читаем время из RTC
//     Jahr = RTC.yyyy;
//     if (Jahr > 99) Jahr -= 2000; // Преобразуем год в двузначный формат
//     Monat = RTC.mm;
//     Tag = RTC.dd;
//     WoTag = RTC.dow - 1; // Воскресенье = 0
//     Stunde = RTC.h;
//     Minute = RTC.m;
//     Sekunde = RTC.s;

//     // Создаем структуру tmElements_t для передачи в makeTime
//     tmElements_t tm;
//     tm.Year = RTC.yyyy - 1970; // Год отсчитывается от 1970 в Time.h
//     tm.Month = RTC.mm;
//     tm.Day = RTC.dd;
//     tm.Hour = RTC.h;
//     tm.Minute = RTC.m;
//     tm.Second = RTC.s;

//     // Преобразуем время в локальное с учетом часового пояса
//     time_t localTime = myTZ.toLocal(makeTime(tm));
//     Stunde = hour(localTime); // Получаем локальные часы
//     Minute = minute(localTime); // Получаем локальные минуты
//     Sekunde = second(localTime); // Получаем локальные секунды

//     MEZ.WT = WoTag;
//     MEZ.sek1 = Sekunde % 10;
//     MEZ.sek2 = Sekunde / 10;
//     MEZ.sek12 = Sekunde;
//     MEZ.min1 = Minute % 10;
//     MEZ.min2 = Minute / 10;
//     MEZ.min12 = Minute;
//     MEZ.hour1 = Stunde % 10;
//     MEZ.hour2 = Stunde / 10;
//     MEZ.hour12 = Stunde;
//     MEZ.tag12 = Tag;
//     MEZ.tag1 = Tag % 10;
//     MEZ.tag2 = Tag / 10;
//     MEZ.mon12 = Monat;
//     MEZ.mon1 = Monat % 10;
//     MEZ.mon2 = Monat / 10;
//     MEZ.year12 = Jahr;
//     MEZ.year1 = Jahr % 10;
//     MEZ.year2 = (Jahr % 100) / 10;
// }

void rtc2mez()
{
    DateTime now = rtc.now(); // Читаем время из RTC
    time_t utc = now.unixtime();
    time_t localTime = myTZ.toLocal(utc); // Преобразуем в локальное время с учетом часового пояса

    Tag = day(localTime); // Получаем локальный день
    Monat = month(localTime); // Получаем локальный месяц
    Jahr = year(localTime); // Получаем локальный год
    WoTag = weekday(localTime) - 1; // weekday() возвращает 1-7 (Вс-Сб), корректируем на 0-6
    Stunde = hour(localTime); // Получаем локальные часы
    Minute = minute(localTime); // Получаем локальные минуты
    Sekunde = second(localTime); // Получаем локальные секунды

    MEZ.WT = WoTag;
    MEZ.sek1 = Sekunde % 10;
    MEZ.sek2 = Sekunde / 10;
    MEZ.sek12 = Sekunde;
    MEZ.min1 = Minute % 10;
    MEZ.min2 = Minute / 10;
    MEZ.min12 = Minute;
    MEZ.hour1 = Stunde % 10;
    MEZ.hour2 = Stunde / 10;
    MEZ.hour12 = Stunde;
    MEZ.tag12 = Tag;
    MEZ.tag1 = Tag % 10;
    MEZ.tag2 = Tag / 10;
    MEZ.mon12 = Monat;
    MEZ.mon1 = Monat % 10;
    MEZ.mon2 = Monat / 10;
    MEZ.year12 = Jahr;
    MEZ.year1 = Jahr % 10;
    MEZ.year2 = (Jahr % 100) / 10;
}

void helpArr_init(void)
{
    uint8_t i, j = 0, k = 0;
    for (i = 0; i < NUM_MAX * 8; i++) 
    {
        helpArrPos[i] = (1 << j);
        helpArrMAX[i] = k;
        j++;
        if (j > 7) 
        {
            j = 0;
            k++;
        }
    }
}

void clear_Display()
{
    uint8_t i, j;
    for (i = 0; i < 8; i++)
    {
        digitalWrite(CS_PIN, LOW);
        delayMicroseconds(1);
        for (j = NUM_MAX; j > 0; j--) 
        {
            LEDarr[j - 1][i] = 0;
            shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, CMD_DIGIT0 + i);
            shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, LEDarr[j - 1][i]);
        }
        digitalWrite(CS_PIN, HIGH);
    }
}

void rotate_90()
{
    for (uint8_t k = NUM_MAX; k > 0; k--) 
    {
        uint8_t i, j, m, imask, jmask;
        uint8_t tmp[8] = {0, 0, 0, 0, 0, 0, 0, 0};
        for (i = 0, imask = 0x80; i < 8; i++, imask >>= 1) 
        {
            for (j = 0, jmask = 0x80; j < 8; j++, jmask >>= 1) 
            {
                if (LEDarr[k-1][i] & jmask) 
                {
                    tmp[j] |= imask;
                }
            }
        }
        for (m = 0; m < 8; m++)
        {
            LEDarr[k-1][m] = tmp[m];
        }
    }
}

void rotate_270()
{
    for (uint8_t k = NUM_MAX; k > 0; k--) 
    {
        uint8_t i, j, m, imask, jmask;
        uint8_t tmp[8] = {0, 0, 0, 0, 0, 0, 0, 0};
        for (i = 0, imask = 0x01; i < 8; i++, imask <<= 1) 
        {
            for (j = 0, jmask = 0x01; j < 8; j++, jmask <<= 1) 
            {
                if (LEDarr[k-1][i] & jmask) 
                {
                    tmp[j] |= imask;
                }
            }
        }
        for (m = 0; m < 8; m++)
        {
            LEDarr[k-1][m] = tmp[m];
        }
    }
}

void refresh_display()
{
    uint8_t i, j;
    for (i = 0; i < 8; i++)
    {
        digitalWrite(CS_PIN, LOW);
        delayMicroseconds(1);
        #ifdef REVERSE_VERTICAL
        for (j = 0; j < NUM_MAX; j++)
        #else
        for (j = NUM_MAX; j > 0; j--) 
        #endif
        {
            #ifdef REVERSE_VERTICAL
            shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, CMD_DIGIT7 - i);
            shiftOut(DIN_PIN, CLK_PIN, LSBFIRST, LEDarr[j][i]);
            #else
            shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, CMD_DIGIT0 + i);
            shiftOut(DIN_PIN, CLK_PIN, MSBFIRST, LEDarr[j - 1][i]);
            #endif
        }
        digitalWrite(CS_PIN, HIGH);
    }
}

void char2Arr(uint8_t ch, char PosX, short PosY) 
{
    uint8_t i, j, k, l, m, o1, o2, o3, o4;
    PosX++;
    k = ch - 32;
    if ((k >= 0) && (k < 96))
    {
        o4 = font1[k][0];
        o3 = 1 << (o4 - 2);
        for (i = 0; i < o4; i++) 
        {
            if (((PosX - i <= maxPosX) && (PosX - i >= 0)) && ((PosY > -8) && (PosY < 8)))
            {
                o1 = helpArrPos[PosX - i];
                o2 = helpArrMAX[PosX - i];
                for (j = 0; j < 8; j++) 
                {
                    if (((PosY >= 0) && (PosY <= j)) || ((PosY < 0) && (j < PosY + 8)))
                    {
                        l = font1[k][j + 1];
                        m = (l & (o3 >> i));
                        if (m > 0)
                            LEDarr[o2][j - PosY] |= o1;
                        else
                            LEDarr[o2][j - PosY] &= ~o1;
                    }
                }
            }
        }
    }
}

void char22Arr(uint8_t ch, char PosX, short PosY) 
{
    uint8_t i, j, k, l, m, o1, o2, o3, o4;
    PosX++;
    k = ch - 32;
    if ((k >= 0) && (k < 96))
    {
        o4 = font2[k][0];
        o3 = 1 << (o4 - 2);
        for (i = 0; i < o4; i++) 
        {
            if (((PosX - i <= maxPosX) && (PosX - i >= 0)) && ((PosY > -8) && (PosY < 8)))
            {
                o1 = helpArrPos[PosX - i];
                o2 = helpArrMAX[PosX - i];
                for (j = 0; j < 8; j++) 
                {
                    if (((PosY >= 0) && (PosY <= j)) || ((PosY < 0) && (j < PosY + 8)))
                    {
                        l = font2[k][j + 1];
                        m = (l & (o3 >> i));
                        if (m > 0)
                            LEDarr[o2][j - PosY] |= o1;
                        else
                            LEDarr[o2][j - PosY] &= ~o1;
                    }
                }
            }
        }
    }
}

void char2ArrRus(uint8_t ch, char PosX, short PosY) 
{
    uint8_t i, j, k, l, m, o1, o2, o3, o4;
    PosX++;
    if (ch < 34)
    {
        o4 = Rus[ch][0];
        o3 = 1 << (o4 - 2);
        for (i = 0; i < o4; i++) 
        {
            if (((PosX - i <= maxPosX) && (PosX - i >= 0)) && ((PosY > -8) && (PosY < 8)))
            {
                o1 = helpArrPos[PosX - i];
                o2 = helpArrMAX[PosX - i];
                for (j = 0; j < 8; j++) 
                {
                    if (((PosY >= 0) && (PosY <= j)) || ((PosY < 0) && (j < PosY + 8)))
                    {
                        l = Rus[ch][j + 1];
                        m = (l & (o3 >> i));
                        if (m > 0)
                            LEDarr[o2][j - PosY] |= o1;
                        else
                            LEDarr[o2][j - PosY] &= ~o1;
                    }
                }
            }
        }
    }
}

void timer50ms() 
{
    static uint8_t cnt = 0;
    cnt++;
    if (cnt >= 20) 
    {
        f_tckr1s = true;
        cnt = 0;
    }
    f_tckr50ms = true;
}

void setup() 
{
    Wire.begin();
    // rtc.begin();
 
    // RTC.control(DS3231_12H, DS3231_OFF);
    
    initMAX7219();
    sendCmdAll(CMD_SHUTDOWN, 1);
    sendCmdAll(CMD_INTENSITY, 8);
    clear_Display();
    helpArr_init();
    refresh_display();
    tckr.attach(0.05, timer50ms); // 50ms ticker
       if (!rtc.begin()) 
    {
        // Обработка ошибки, если RTC не найден (например, зациклить или вывести сообщение)
        char22Arr('R', 1, 0);
        refresh_display();
    }
}

void loop() 
{
    uint8_t sek1 = 0, sek2 = 0, min1 = 0, min2 = 0, hour1 = 0, hour2 = 0;
    uint8_t sek11 = 0, sek12 = 0, sek12_prev = 0, sek21 = 0, sek22 = 0;
    uint8_t min11 = 0, min12 = 0, min21 = 0, min22 = 0;
    uint8_t hour11 = 0, hour12 = 0, hour21 = 0, hour22 = 0;
    int x = 0, y = 0, y1 = 0, y2 = 0, y3 = 0;
    bool updown = false;
    uint8_t nomber1 = 0, nomber2 = 0, nomber3 = 0, nomber4 = 0, nomber5 = 0, nomber6 = 0;
    bool f_scrollend_y = false;
    bool f_scroll_x = false;
    static int jj = 0;

    z_PosX = maxPosX;
    d_PosX = -7;

    refresh_display();
    updown = true;
    if (updown) { y2 = 8; y1 = -8; } else { y2 = -9; y1 = 8; }

    while (true) 
    {
        if (jj++ > 3000) { jj = 0; }

        if (f_tckr1s) 
        {
            rtc2mez();
            sek1 = MEZ.sek1;
            sek2 = MEZ.sek2;
            min1 = MEZ.min1;
            min2 = MEZ.min2;
            hour1 = MEZ.hour1;
            hour2 = MEZ.hour2;
            y = y2;
            nomber1 = 1;
            nomber2 = 1;
            nomber3 = 1;
            nomber4 = 1;
            nomber5 = 1;
            nomber6 = 1;

            sek12_prev = sek12;
            sek11 = sek12; sek12 = sek1; sek21 = sek22; sek22 = sek2;
            min11 = min12; min12 = min1; min21 = min22; min22 = min2;
            hour11 = hour12; hour12 = hour1; hour21 = hour22; hour22 = hour2;
            f_tckr1s = false;
            if (MEZ.sek12 == 45) f_scroll_x = true;
        }

        if (f_tckr50ms) 
        {
            clear_Display();
            f_tckr50ms = false;

            if (f_scroll_x) 
            {
                z_PosX++;
                d_PosX++;
                if (d_PosX == 183) z_PosX = 0;
                if (z_PosX == maxPosX) { f_scroll_x = false; d_PosX = -8; }
            }

            // Seconds (units)
            if (nomber1) 
            {
                if (updown) y--; else y++;
                y3 = y;
                if (y3 > 0) y3 = 0;
                char22Arr(48 + sek12, z_PosX - sec1_position, y3);
                char22Arr(48 + sek11, z_PosX - sec1_position, y + y1);
                if (y == 0) { nomber1 = 0; f_scrollend_y = true; }
            }
            else char22Arr(48 + sek1, z_PosX - sec1_position, 0);

            // Seconds (tens)
            if (nomber2) 
            {
                char22Arr(48 + sek22, z_PosX - sec2_position, y3);
                char22Arr(48 + sek21, z_PosX - sec2_position, y + y1);
                if (y == 0) nomber2 = 0;
            }
            else char22Arr(48 + sek2, z_PosX - sec2_position, 0);

            // Minutes (units)
            if (nomber3) 
            {
                char22Arr(48 + min12, z_PosX - min1_position, y3);
                char22Arr(48 + min11, z_PosX - min1_position, y + y1);
                if (y == 0) nomber3 = 0;
            }
            else char22Arr(48 + min1, z_PosX - min1_position, 0);

            // Minutes (tens)
            if (nomber4) 
            {
                char22Arr(48 + min22, z_PosX - min2_position, y3);
                char22Arr(48 + min21, z_PosX - min2_position, y + y1);
                if (y == 0) nomber4 = 0;
            }
            else char22Arr(48 + min2, z_PosX - min2_position, 0);

            // Hours (units)
            if (nomber5) 
            {
                char22Arr(48 + hour12, z_PosX - hour1_position, y3);
                char22Arr(48 + hour11, z_PosX - hour1_position, y + y1);
                if (y == 0) nomber5 = 0;
            }
            else char22Arr(48 + hour1, z_PosX - hour1_position, 0);

            // Hours (tens)
            if (nomber6) 
            {
                char22Arr(48 + hour22, z_PosX - hour2_position, y3);
                char22Arr(48 + hour21, z_PosX - hour2_position, y + y1);
                if (y == 0) nomber6 = 0;
            }
            else char22Arr(48 + hour2, z_PosX - hour2_position, 0);

            // Colon between hours and minutes
            if (MEZ.sek12 % 2 == 0) // Blink colon every second
                char22Arr(':', z_PosX - colon_position, 0);

            refresh_display();
        }
    }
}